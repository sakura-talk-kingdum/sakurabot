<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ° ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

<style>
body {
  font-family: system-ui;
  background: #f0f2f5;
  margin: 0;
}
header {
  background: #5865F2;
  color: #fff;
  padding: 14px;
  font-size: 1.3rem;
}
main {
  padding: 20px;
}
.set {
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}
.items {
  margin-top: 10px;
  padding-left: 10px;
}
.item {
  background: #fafafa;
  padding: 8px;
  border-radius: 6px;
  margin: 6px 0;
}
input, select, button {
  padding: 6px;
  margin: 2px;
}
button {
  cursor: pointer;
}
.toggle {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
small {
  color: #666;
}
</style>
</head>

<body>
<header>ğŸ° ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</header>

<main>
<h3>ã‚¬ãƒãƒ£ã‚»ãƒƒãƒˆä½œæˆ</h3>
<input id="new-name" placeholder="ã‚»ãƒƒãƒˆå">
<input id="new-channel" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ID">
<input id="new-trigger" placeholder="ãƒˆãƒªã‚¬ãƒ¼">
<button onclick="createSet()">ä½œæˆ</button>

<hr>
<div id="sets"></div>
</main>

<script>
const API = '/gachas'
const $ = id => document.getElementById(id)

/* ========= SET ========= */

async function loadSets(){
  const res = await fetch(`${API}/sets`, { credentials:'include' })
  const sets = await res.json()

  $('sets').innerHTML = ''
  for(const s of sets){
    $('sets').insertAdjacentHTML('beforeend', renderSet(s))
    loadItems(s.id)
  }
}

function renderSet(s){
  return `
  <div class="set" id="set-${s.id}">
    <b>${s.name}</b>
    <small>(${s.channel_id} / ${s.trigger_word})</small>

    <div class="toggle">
      <label>æœ‰åŠ¹</label>
      <input type="checkbox" ${s.enabled ? 'checked' : ''}
        onchange="toggleSet('${s.id}', this.checked)">
    </div>

    <div>
      <input id="sname-${s.id}" placeholder="ã‚»ãƒƒãƒˆå" value="${s.name}">
      <input id="sch-${s.id}" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ID" value="${s.channel_id}">
      <input id="str-${s.id}" placeholder="ãƒˆãƒªã‚¬ãƒ¼" value="${s.trigger_word}">
      <button onclick="saveSet('${s.id}')">ä¿å­˜</button>
      <button onclick="deleteSet('${s.id}')">å‰Šé™¤</button>
    </div>

    <div class="items" id="items-${s.id}"></div>

    <div>
      <input id="iname-${s.id}" placeholder="ã‚¢ã‚¤ãƒ†ãƒ å">
      <input id="idesc-${s.id}" placeholder="èª¬æ˜">
      <input id="iamount-${s.id}" type="number" placeholder="å€‹æ•°">
      <select id="irarity-${s.id}">
        <option>common</option>
        <option>uncommon</option>
        <option>rare</option>
        <option>epic</option>
        <option>legend</option>
        <option>superlegend</option>
      </select>
      <button onclick="addItem('${s.id}')">è¿½åŠ </button>
    </div>
  </div>`
}

async function createSet(){
  const name = $('new-name').value.trim()
  const channel_id = $('new-channel').value.trim()
  const trigger_word = $('new-trigger').value.trim()
  if(!name || !channel_id || !trigger_word) return alert('å¿…é ˆ')

  await fetch(`${API}/sets`,{
    method:'POST',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ guild_id:'guild', name, channel_id, trigger_word })
  })

  $('new-name').value=''
  $('new-channel').value=''
  $('new-trigger').value=''
  loadSets()
}

async function saveSet(id){
  const body = {}
  const name = $(`sname-${id}`).value.trim()
  const channel_id = $(`sch-${id}`).value.trim()
  const trigger_word = $(`str-${id}`).value.trim()
  if(name) body.name = name
  if(channel_id) body.channel_id = channel_id
  if(trigger_word) body.trigger_word = trigger_word

  await fetch(`${API}/sets/${id}`,{
    method:'PATCH',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  })
}

async function toggleSet(id, enabled){
  await fetch(`${API}/sets/${id}`,{
    method:'PATCH',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ enabled })
  })
}

async function deleteSet(id){
  if(!confirm('å‰Šé™¤ï¼Ÿ')) return
  await fetch(`${API}/sets/${id}`,{
    method:'DELETE',
    credentials:'include'
  })
  loadSets()
}

/* ========= ITEM ========= */

async function loadItems(setId){
  const res = await fetch(`${API}/sets/${setId}/items`,{ credentials:'include' })
  const items = await res.json()

  const el = $(`items-${setId}`)
  el.innerHTML = '<b>ã‚¢ã‚¤ãƒ†ãƒ </b>'

  for(const i of items){
    el.insertAdjacentHTML('beforeend', `
      <div class="item">
        <input value="${i.name}" id="iname-${i.id}">
        <input value="${i.desc}" id="idesc-${i.id}">
        <input value="${i.amount}" type="number" id="iamount-${i.id}">
        <select id="irarity-${i.id}">
          ${['common','uncommon','rare','epic','legend','superlegend']
            .map(r=>`<option ${i.rarity===r?'selected':''}>${r}</option>`).join('')}
        </select>
        <button onclick="saveItem('${setId}','${i.id}')">ä¿å­˜</button>
        <button onclick="deleteItem('${setId}','${i.id}')">å‰Šé™¤</button>
      </div>
    `)
  }
}

async function addItem(setId){
  const name = $(`iname-${setId}`).value.trim()
  const description = $(`idesc-${setId}`).value.trim()
  const amount = Number($(`iamount-${setId}`).value)
  const rarity = $(`irarity-${setId}`).value
  if(!name || amount<=0) return alert('ä¸æ­£')

  await fetch(`${API}/sets/${setId}/items`,{
    method:'POST',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ name, description, amount, rarity })
  })
  loadItems(setId)
}

async function saveItem(setId,itemId){
  const body = {}
  const name = $(`iname-${itemId}`).value.trim()
  const description = $(`idesc-${setId}`).value.trim()
  const amount = Number($(`iamount-${itemId}`).value)
  const rarity = $(`irarity-${itemId}`).value
  if(name) body.name = name
  if(description) body.description = description
  if(amount>0) body.amount = amount
  if(rarity) body.rarity = rarity

  await fetch(`${API}/sets/${setId}/items/${itemId}`,{
    method:'PATCH',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  })
}

async function deleteItem(setId,itemId){
  if(!confirm('å‰Šé™¤ï¼Ÿ')) return
  await fetch(`${API}/sets/${setId}/items/${itemId}`,{
    method:'DELETE',
    credentials:'include'
  })
  loadItems(setId)
}

/* ========= INIT ========= */
loadSets()
</script>
</body>
</html>
