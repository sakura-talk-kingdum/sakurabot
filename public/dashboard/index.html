<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
body { font-family: system-ui; background:#f0f2f5; margin:0 }
header { background:#5865F2; color:#fff; padding:15px; font-size:1.4rem }
main { padding:20px }
.set { background:#fff; border-radius:8px; padding:15px; margin-bottom:20px }
.items { margin-top:10px; padding-left:10px }
.item { background:#fafafa; padding:6px; border-radius:6px; margin:5px 0 }
input,select,button { padding:6px; margin:2px }
small { color:#666 }
</style>
</head>

<body>
<header>ğŸ° ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</header>
<main>

<h3>ã‚¬ãƒãƒ£ã‚»ãƒƒãƒˆä½œæˆ</h3>
<input id="new-name" placeholder="ã‚»ãƒƒãƒˆå">
<input id="new-channel" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ID">
<input id="new-trigger" placeholder="ãƒˆãƒªã‚¬ãƒ¼">
<button onclick="createSet()">ä½œæˆ</button>

<hr>

<div id="sets"></div>

</main>

<script>
const API = '/gachas'

/* ========= SET ========= */

async function loadSets(){
  const sets = await fetch(`${API}/sets`).then(r=>r.json())
  const el = document.getElementById('sets')
  el.innerHTML = ''
  for(const s of sets){
    el.innerHTML += renderSet(s)
    loadItems(s.id)
  }
}

function renderSet(s){
  return `
  <div class="set" id="set-${s.id}">
    <b>${s.name}</b>
    <small>(${s.channel_id} / ${s.trigger_word})</small><br>

    æœ‰åŠ¹ <input type="checkbox" ${s.enabled?'checked':''}
      onchange="toggleSet('${s.id}',this.checked)">

    <button onclick="editSet('${s.id}')">ç·¨é›†</button>
    <button onclick="deleteSet('${s.id}')">å‰Šé™¤</button>

    <div class="items" id="items-${s.id}"></div>

    <div>
      <input placeholder="ã‚¢ã‚¤ãƒ†ãƒ å" id="iname-${s.id}">
      <input placeholder="èª¬æ˜" id="idesc-${s.id}">
      <input type="number" placeholder="å€‹æ•°" id="iamount-${s.id}">
      <select id="irarity-${s.id}">
        <option>common</option><option>uncommon</option><option>rare</option>
        <option>epic</option><option>legend</option><option>superlegend</option>
      </select>
      <button onclick="addItem('${s.id}')">è¿½åŠ </button>
    </div>
  </div>`
}

async function createSet(){
  await fetch(`${API}/sets`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      guild_id:'guild',
      name:newName.value,
      channel_id:newChannel.value,
      trigger_word:newTrigger.value
    })
  })
  loadSets()
}

async function editSet(id){
  const name = prompt('ã‚»ãƒƒãƒˆå')
  const channel_id = prompt('ãƒãƒ£ãƒ³ãƒãƒ«ID')
  const trigger_word = prompt('ãƒˆãƒªã‚¬ãƒ¼')
  if(!name) return
  await fetch(`${API}/sets/${id}`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name,channel_id,trigger_word})
  })
  loadSets()
}

async function deleteSet(id){
  if(!confirm('å‰Šé™¤ã™ã‚‹ï¼Ÿ')) return
  await fetch(`${API}/sets/${id}`,{method:'DELETE'})
  loadSets()
}

async function toggleSet(id,enabled){
  await fetch(`${API}/set/toggle`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({set_id:id,enabled})
  })
}

/* ========= ITEM ========= */

async function loadItems(setId){
  const items = await fetch(`${API}/sets/${setId}/items`).then(r=>r.json())
  const el = document.getElementById(`items-${setId}`)
  el.innerHTML = '<b>ã‚¢ã‚¤ãƒ†ãƒ </b>'
  for(const i of items){
    el.innerHTML += `
    <div class="item">
      ${i.name} (${i.amount}) [${i.rarity}]<br>
      <small>${i.description||''}</small><br>
      <button onclick="editItem('${setId}','${i.id}')">ç·¨é›†</button>
      <button onclick="deleteItem('${setId}','${i.id}')">å‰Šé™¤</button>
    </div>`
  }
}

async function addItem(setId){
  await fetch(`${API}/sets/${setId}/items`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      display_id:Date.now(),
      name:document.getElementById(`iname-${setId}`).value,
      description:document.getElementById(`idesc-${setId}`).value,
      amount:+document.getElementById(`iamount-${setId}`).value,
      rarity:document.getElementById(`irarity-${setId}`).value
    })
  })
  loadItems(setId)
}

async function editItem(setId,itemId){
  const name = prompt('åå‰')
  const description = prompt('èª¬æ˜')
  const amount = +prompt('å€‹æ•°')
  const rarity = prompt('ãƒ¬ã‚¢ãƒªãƒ†ã‚£')
  await fetch(`${API}/sets/${setId}/items/${itemId}`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name,description,amount,rarity})
  })
  loadItems(setId)
}

async function deleteItem(setId,itemId){
  if(!confirm('å‰Šé™¤ï¼Ÿ')) return
  await fetch(`${API}/sets/${setId}/items/${itemId}`,{method:'DELETE'})
  loadItems(setId)
}

/* ========= INIT ========= */
loadSets()
</script>
</body>
</html>
