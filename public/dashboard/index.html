<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ° ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
body{font-family:system-ui;background:#f0f2f5;margin:0}
header{background:#5865F2;color:#fff;padding:14px;font-size:1.3rem}
main{padding:20px}
.set{background:#fff;border-radius:8px;padding:15px;margin-bottom:20px}
.items{margin-top:10px;padding-left:10px}
.item{background:#fafafa;padding:6px;border-radius:6px;margin:6px 0}
input,select,button{padding:6px;margin:2px}
button{cursor:pointer}
small{color:#666}
</style>
</head>

<body>
<header>ğŸ° ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</header>
<main>

<h3>ã‚¬ãƒãƒ£ã‚»ãƒƒãƒˆä½œæˆ</h3>
<input id="new-name" placeholder="ã‚»ãƒƒãƒˆå">
<input id="new-channel" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ID">
<input id="new-trigger" placeholder="ãƒˆãƒªã‚¬ãƒ¼">
<button onclick="createSet()">ä½œæˆ</button>

<hr>
<div id="sets"></div>

</main>

<script>
const API = '/gachas'
const $ = id => document.getElementById(id)

/* ========= SET ========= */

async function loadSets(){
  const res = await fetch(`${API}/sets`,{credentials:'include'})
  const sets = await res.json()

  $('sets').innerHTML = ''
  for(const s of sets){
    $('sets').insertAdjacentHTML('beforeend', renderSet(s))
    loadItems(s.id)
  }
}

function renderSet(s){
  return `
  <div class="set" id="set-${s.id}">
    <b>${s.name}</b>
    <small>(${s.channel_id} / ${s.trigger_word})</small><br>

    <button onclick="editSet('${s.id}')">ç·¨é›†</button>
    <button onclick="deleteSet('${s.id}')">å‰Šé™¤</button>

    <div class="items" id="items-${s.id}"></div>

    <div>
      <input id="iname-${s.id}" placeholder="ã‚¢ã‚¤ãƒ†ãƒ å">
      <input id="idesc-${s.id}" placeholder="èª¬æ˜">
      <input id="iamount-${s.id}" type="number" placeholder="å€‹æ•°">
      <select id="irarity-${s.id}">
        <option value="common">common</option>
        <option value="uncommon">uncommon</option>
        <option value="rare">rare</option>
        <option value="epic">epic</option>
        <option value="legend">legend</option>
        <option value="superlegend">superlegend</option>
      </select>
      <button onclick="addItem('${s.id}')">è¿½åŠ </button>
    </div>
  </div>`
}

async function createSet(){
  const name = $('new-name').value.trim()
  const channel_id = $('new-channel').value.trim()
  const trigger_word = $('new-trigger').value.trim()

  if(!name || !channel_id || !trigger_word){
    return alert('å…¨éƒ¨å¿…é ˆ')
  }

  await fetch(`${API}/sets`,{
    method:'POST',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ guild_id:'guild', name, channel_id, trigger_word })
  })

  $('new-name').value=''
  $('new-channel').value=''
  $('new-trigger').value=''
  loadSets()
}

async function editSet(id){
  const name = prompt('ã‚»ãƒƒãƒˆå')
  if(!name) return

  const channel_id = prompt('ãƒãƒ£ãƒ³ãƒãƒ«ID')
  const trigger_word = prompt('ãƒˆãƒªã‚¬ãƒ¼')
  const enabled = prompt('æœ‰åŠ¹ã«ã™ã‚‹ï¼Ÿ (TRUE/FALSE)') 

  await fetch(`${API}/sets/${id}`,{
    method:'PUT',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ name, channel_id, trigger_word ,enabled })
  })
  loadSets()
}

async function deleteSet(id){
  if(!confirm('å‰Šé™¤ã™ã‚‹ï¼Ÿ')) return
  await fetch(`${API}/sets/${id}`,{method:'DELETE',credentials:'include'})
  loadSets()
}

/* ========= ITEM ========= */

async function loadItems(setId){
  const res = await fetch(`${API}/sets/${setId}/items`,{credentials:'include'})
  const items = await res.json()

  const el = $(`items-${setId}`)
  el.innerHTML = '<b>ã‚¢ã‚¤ãƒ†ãƒ </b>'

  for(const i of items){
    el.insertAdjacentHTML('beforeend', `
      <div class="item">
        <b>${i.name}</b> (${i.amount}) [${i.rarity}]<br>
        <small>${i.description ?? ''}</small><br>
        <button onclick="editItem('${setId}','${i.id}')">ç·¨é›†</button>
        <button onclick="deleteItem('${setId}','${i.id}')">å‰Šé™¤</button>
      </div>
    `)
  }
}

async function addItem(setId){
  const name = $(`iname-${setId}`).value.trim()
  const description = $(`idesc-${setId}`).value || null
  const amount = Number($(`iamount-${setId}`).value)
  const rarity = $(`irarity-${setId}`).value

  if(!name) return alert('åå‰å¿…é ˆ')
  if(!Number.isInteger(amount) || amount <= 0) return alert('å€‹æ•°ä¸æ­£')

  await fetch(`${API}/sets/${setId}/items`,{
    method:'POST',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      display_id: Math.floor(Math.random()*1000000),
      name,
      description,
      amount,
      rarity
    })
  })

  $(`iname-${setId}`).value=''
  $(`idesc-${setId}`).value=''
  $(`iamount-${setId}`).value=''
  loadItems(setId)
}

async function editItem(setId,itemId){
  const name = prompt('åå‰')
  if(!name) return alert('åå‰å¿…é ˆ')

  const amount = Number(prompt('å€‹æ•°'))
  if(!Number.isInteger(amount) || amount<=0) return alert('å€‹æ•°ä¸æ­£')

  const rarity = prompt('ãƒ¬ã‚¢ãƒªãƒ†ã‚£')
  if(!rarity) return

  const description = prompt('èª¬æ˜') ?? null

  const res = await fetch(`${API}/sets/${setId}/items/${itemId}`,{
    method:'PUT',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ name, description, amount, rarity })
  })

  if(!res.ok){
    const e = await res.json()
    alert(e.message)
    return
  }

  loadItems(setId)
}

async function deleteItem(setId,itemId){
  if(!confirm('å‰Šé™¤ï¼Ÿ')) return
  const res = await fetch(`${API}/sets/${setId}/items/${itemId}`,{
    method:'DELETE',
    credentials:'include'
  })
  if(!res.ok){
    const e = await res.json()
    alert(e.message)
    return
  }
  loadItems(setId)
}

/* ========= INIT ========= */
loadSets()
</script>
</body>
</html>
