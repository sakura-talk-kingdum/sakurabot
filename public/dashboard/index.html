<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
body { font-family: Arial,sans-serif; background:#f0f2f5; margin:0; }
header { background:#5865F2; color:#fff; padding:15px; text-align:center; font-size:1.4rem; }
main { padding:20px; }
h2 { margin-top:30px; }
.card { background:#fff; border:1px solid #ccc; padding:12px; margin-top:15px; }
button { padding:5px 10px; margin:2px; cursor:pointer; }
input, select { padding:5px; margin:2px; }
.form-inline { display:flex; gap:5px; flex-wrap:wrap; }
.form-inline input, .form-inline select { flex:1; }
.items { margin-top:10px; padding-left:10px; }
.item { margin:4px 0; }
.small { font-size:0.85em; color:#666; }
</style>
</head>

<body>
<header>ğŸ° ã‚¬ãƒãƒ£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</header>

<main>
<h2>ã‚¬ãƒãƒ£ã‚»ãƒƒãƒˆä½œæˆ</h2>
<div class="card">
  <input id="new-name" placeholder="ã‚»ãƒƒãƒˆå">
  <input id="new-channel" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ID">
  <input id="new-trigger" placeholder="ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
  <button id="create-set">ä½œæˆ</button>
</div>

<h2>ã‚¬ãƒãƒ£ã‚»ãƒƒãƒˆä¸€è¦§</h2>
<div id="sets"></div>
</main>

<script>
const API = '/gachas';

/* =====================
  ã‚¬ãƒãƒ£ã‚»ãƒƒãƒˆä¸€è¦§
===================== */
async function fetchSets() {
  const res = await fetch(`${API}/sets`);
  const sets = await res.json();
  renderSets(sets);
}

function renderSets(sets) {
  const root = document.getElementById('sets');
  root.innerHTML = '';

  sets.forEach(set => {
    const div = document.createElement('div');
    div.className = 'card';

    div.innerHTML = `
      <strong>${set.name}</strong>
      <div class="small">
        ãƒãƒ£ãƒ³ãƒãƒ«: ${set.channel_id} / ãƒˆãƒªã‚¬ãƒ¼: ${set.trigger_word}
      </div>

      æœ‰åŠ¹:
      <input type="checkbox" class="toggle" data-id="${set.id}" ${set.enabled ? 'checked' : ''}>

      <button class="edit-set" data-id="${set.id}">ç·¨é›†</button>
      <button class="delete-set" data-id="${set.id}">å‰Šé™¤</button>

      <div class="items" data-setid="${set.id}"></div>

      <div class="form-inline">
        <input class="item-name" placeholder="ã‚¢ã‚¤ãƒ†ãƒ å">
        <input class="item-desc" placeholder="èª¬æ˜">
        <input class="item-amount" type="number" min="1" placeholder="å€‹æ•°">
        <select class="item-rarity">
          <option>common</option>
          <option>uncommon</option>
          <option>rare</option>
          <option>epic</option>
          <option>legend</option>
          <option>superlegend</option>
        </select>
        <button class="add-item">è¿½åŠ </button>
      </div>
    `;

    root.appendChild(div);
    fetchItems(set.id);
  });

  bindSetEvents();
}

/* =====================
  ã‚»ãƒƒãƒˆæ“ä½œ
===================== */
function bindSetEvents() {
  document.querySelectorAll('.toggle').forEach(el=>{
    el.onchange = () =>
      fetch(`${API}/set/toggle`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ set_id: el.dataset.id, enabled: el.checked })
      });
  });

  document.querySelectorAll('.delete-set').forEach(btn=>{
    btn.onclick = async () => {
      if (!confirm('å‰Šé™¤ã™ã‚‹ï¼Ÿ')) return;
      await fetch(`${API}/sets/${btn.dataset.id}`, { method:'DELETE' });
      fetchSets();
    };
  });

  document.querySelectorAll('.edit-set').forEach(btn=>{
    btn.onclick = async () => {
      const name = prompt('ã‚»ãƒƒãƒˆå');
      const channel_id = prompt('ãƒãƒ£ãƒ³ãƒãƒ«ID');
      const trigger_word = prompt('ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰');
      if (!name || !channel_id || !trigger_word) return;

      await fetch(`${API}/sets/${btn.dataset.id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, channel_id, trigger_word })
      });
      fetchSets();
    };
  });

  document.querySelectorAll('.add-item').forEach(btn=>{
    btn.onclick = async () => {
      const card = btn.closest('.card');
      const setId = card.querySelector('.items').dataset.setid;

      const name = card.querySelector('.item-name').value;
      const description = card.querySelector('.item-desc').value;
      const amount = parseInt(card.querySelector('.item-amount').value);
      const rarity = card.querySelector('.item-rarity').value;

      if (!name || !amount) return alert('å…¥åŠ›ä¸è¶³');

      await fetch(`${API}/sets/${setId}/items`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify([{
          display_id: Date.now(),
          name, description, amount, rarity
        }])
      });

      card.querySelector('.item-name').value='';
      card.querySelector('.item-desc').value='';
      card.querySelector('.item-amount').value='';

      fetchItems(setId);
    };
  });
}

/* =====================
  ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§
===================== */
async function fetchItems(setId) {
  const res = await fetch(`${API}/sets/${setId}/items`);
  const items = await res.json();
  const box = document.querySelector(`.items[data-setid="${setId}"]`);

  box.innerHTML = items.map(i => `
    <div class="item">
      ${i.name} (${i.amount}) [${i.rarity}]
      <span class="small">${i.description ?? ''}</span>
      <button onclick="editItem('${i.id}','${setId}')">ç·¨é›†</button>
      <button onclick="deleteItem('${i.id}','${setId}')">å‰Šé™¤</button>
    </div>
  `).join('');
}

async function editItem(itemId, setId) {
  const name = prompt('åå‰');
  const description = prompt('èª¬æ˜');
  const amount = parseInt(prompt('å€‹æ•°'));
  const rarity = prompt('ãƒ¬ã‚¢ãƒªãƒ†ã‚£');

  if (!name || !amount || !rarity) return;

  await fetch(`${API}/items/${itemId}`, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ name, description, amount, rarity })
  });

  fetchItems(setId);
}

async function deleteItem(itemId, setId) {
  if (!confirm('å‰Šé™¤ã™ã‚‹ï¼Ÿ')) return;
  await fetch(`${API}/items/${itemId}`, { method:'DELETE' });
  fetchItems(setId);
}

/* =====================
  ã‚»ãƒƒãƒˆä½œæˆ
===================== */
document.getElementById('create-set').onclick = async () => {
const name = document.getElementById('new-name').value;
const channel_id = document.getElementById('new-channel').value;
const trigger_word = document.getElementById('new-trigger').value;

  if (!name || !channel_id || !trigger_word) return;

  await fetch(`${API}/sets`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      guild_id: 'guild-id',
      name, channel_id, trigger_word
    })
  });

  fetchSets();
};

fetchSets();
</script>
</body>
</html>
